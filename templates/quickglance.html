{# Quick Glance Mode #}
{# Defensive: ensure state.content is a dict #}
{% set content = {} %}
{% if state.content is mapping %}
    {% set content = state.content %}
{% elif state.content is iterable and state.content is not string %}
    {% set content = {} %}
{% endif %}

{% if config %}
<style>
.qg-current-time { font-size: {{ config.font_clock|default('5rem') }}; }
.qg-date { font-size: {{ config.font_date|default('1.4rem') }}; }
.qg-label { font-size: {{ config.font_label|default('1.1rem') }}; }
.qg-event-name { font-size: {{ config.font_event|default('2.2rem') }}; }
.qg-event-time { font-size: {{ config.font_event_time|default('1.6rem') }}; }
.qg-weather-icon { font-size: {{ config.font_weather_icon|default('3rem') }}; }
.qg-weather-temp { font-size: {{ config.font_weather_temp|default('2.8rem') }}; }
.qg-dinner-text { font-size: {{ config.font_dinner|default('2rem') }}; }
</style>
{% endif %}
<div class="quick-glance animate-in">
    <div class="qg-left-col">
        <div class="qg-time-block">
            <div class="qg-current-time live-time">{{ content.time }}</div>
            <span class="qg-countdown {% if content.countdown_urgency == 'critical' %}critical{% elif content.countdown_urgency == 'urgent' %}warning{% endif %}">
                {% if content.countdown %}{{ content.countdown }}{% endif %}
                {% if content.countdown_label %} ({{ content.countdown_label }}){% endif %}
            </span>
            <div class="qg-date live-date">{{ content.date }}</div>
        </div>
        <div class="qg-current-event">
            <span class="qg-label">NOW</span>
            <span class="qg-event-name">{{ content.current_event if content.current_event else "Free Time" }}</span>
            {% if content.current_event_time %}
            <span class="qg-event-time">ends {{ content.current_event_time }}</span>
            {% endif %}
        </div>
        <div class="qg-next-event">
            <span class="qg-label">NEXT</span>
            <span class="qg-event-name">{{ content.next_event if content.next_event else "Nothing scheduled" }}</span>
            {% if content.next_event_time %}
            <span class="qg-event-time">starts {{ content.next_event_time }}</span>
            {% endif %}
        </div>
    </div>
    
    <div class="qg-right-col">
        <div class="qg-weather-block">
            <span class="qg-weather-icon">{{ content.weather_icon }}</span>
            <span class="qg-weather-temp">{{ content.weather_temp }}</span>
            <span class="qg-weather-highlow">{{ content.weather_high }}° / {{ content.weather_low }}°</span>
        </div>
        <div class="qg-dinner">
            <span class="qg-label">DINNER</span>
            <span class="qg-dinner-text">{{ content.dinner if content.dinner else "TBD" }}</span>
        </div>
        <div class="qg-tasks-block">
            <span class="qg-label">TASKS</span>
            <div class="qg-tasks-list">
                {% set tasks = content.get('tasks', []) %}
                {% for task in tasks[:5] %}
                <div class="task-item">
                    <span class="task-name">{{ task.name }}</span>
                    {% if task.due %}<span class="task-due">{{ task.due }}</span>{% endif %}
                </div>
                {% else %}
                No tasks
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.quick-glance {
    display: grid;
    grid-template-columns: 65% 35%;
    gap: 20px;
    padding: 30px;
    height: 100vh;
    box-sizing: border-box;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

.qg-left-col {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.qg-right-col {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.qg-header {
    padding: 10px 0;
}

.qg-title {
    font-size: 1.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: #ffd700;
}

.qg-time-block {
    text-align: center;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 16px;
}

.qg-current-time {
    font-size: 5rem;
    font-weight: 700;
    color: #fff;
    line-height: 1.1;
}

.qg-date {
    font-size: 1.4rem;
    color: rgba(255,255,255,0.7);
    margin-top: 8px;
}

.qg-current-event, .qg-next-event {
    padding: 20px;
    background: rgba(255,255,255,0.08);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
}

.qg-label {
    display: block;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: #ffd700;
    font-weight: 700;
    margin-bottom: 8px;
}

.qg-event-name {
    display: block;
    font-size: 2.2rem;
    font-weight: 600;
    color: #fff;
}

.qg-event-time {
    display: block;
    font-size: 1.6rem;
    color: rgba(255,255,255,0.6);
    margin-top: 4px;
}

.qg-weather-block {
    padding: 12px 16px;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
}

.qg-weather-icon {
    font-size: 2rem;
}

.qg-weather-temp {
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
}

.qg-weather-highlow {
    font-size: 1rem;
    color: rgba(255,255,255,0.5);
}

.qg-dinner {
    padding: 12px 16px;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    text-align: left;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
}

.qg-dinner .qg-label {
    color: #ffd700;
    margin-bottom: 0;
}

.qg-dinner-text {
    font-size: 1.4rem;
    font-weight: 600;
    color: #fff;
}

.qg-tasks-block {
    padding: 12px 16px;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    text-align: left;
}

.qg-tasks-block .qg-label {
    color: #ffd700;
    margin-bottom: 8px;
}

.qg-tasks-list {
    font-size: 1.1rem;
    color: rgba(255,255,255,0.8);
    line-height: 1.5;
}

.task-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.task-item:last-child {
    border-bottom: none;
}

.task-name {
    color: #fff;
}

.task-due {
    color: #ffd700;
    font-size: 0.9rem;
}

/* Countdown inline */
.qg-countdown {
    display: block;
    font-size: 1.2rem;
    color: rgba(255,255,255,0.6);
    margin-top: 5px;
}

.qg-countdown.warning {
    background: #ffd700;
    color: #000;
    padding: 4px 12px;
    border-radius: 8px;
    font-weight: 700;
    display: inline-block;
}

.qg-countdown.critical {
    background: #ff4444;
    color: #fff;
    padding: 4px 12px;
    border-radius: 8px;
    font-weight: 700;
    display: inline-block;
}
</style>

<script>
(function() {
    const workerCode = `
        function formatTime() {
            const now = new Date();
            return {
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                date: now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })
            };
        }
        postMessage(formatTime());
        setInterval(() => postMessage(formatTime()), 1000);
    `;

    const blob = new Blob([workerCode], { type: 'application/javascript' });
    const worker = new Worker(URL.createObjectURL(blob));

    worker.onmessage = ({ data }) => {
        const { time, date } = data;
        document.querySelectorAll('.live-time').forEach(el => el.textContent = time);
        document.querySelectorAll('.live-date').forEach(el => el.textContent = date);
    };
})();
</script>
